<!DOCTYPE html>
<html>

<head>
    <title>template</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="Description" content="Learning Rust Wasm/Webassembly programming and having fun">
    <meta name="author" content="https://github.com/bestia-dev">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/bestia01.css">
    <script>
        /* Toggle between adding and removing the "responsive" class to navbar when the user clicks on the hamburger */
        function toggle_responsive_navbar() {
            var x = document.getElementById("navbar");
            if (x.className.includes(" responsive")) {
                x.className = x.className.replace(" responsive", "");
            } else {
                x.className += " responsive";
            }
        }
    </script>
</head>

<body>
    <div class="fixed_header">
        <div id="navbar">
            <a id="navbar_brand" href="https://bestia.dev">
                <img src="bestia_icon.png" alt="Bestia development" title="bestia.dev" />
                <span id="navbar_title"> Bestia dev</span>
            </a>
            <a id="navbar_hamburger" href="javascript:void(0);" onclick="toggle_responsive_navbar()">â˜° </a>
            <div id="navbar_topics">
                <a href="/index.html#home" onclick="toggle_responsive_navbar()">Home </a>
                <a href="/index.html#tutorials" onclick="toggle_responsive_navbar()">Tutorials</a>
                <a href="/index.html#games" onclick="toggle_responsive_navbar()">Games</a>
                <a href="/index.html#productivity" onclick="toggle_responsive_navbar()">Productivity</a>
                <a href="/index.html#contact" onclick="toggle_responsive_navbar()">Contact</a>
            </div>
        </div>
    </div>

<article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-longan_nano_rust_wsl2_platformio_setup" class="anchor" aria-hidden="true" href="#longan_nano_rust_wsl2_platformio_setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>longan_nano_rust_wsl2_platformio_setup</h1>
<p dir="auto"><strong>How to setup a development environment for rust in Win10 + WSL2 + VSCode for Longan nano GD32 Risc-V development board</strong><br>
<em><strong>version: 1.0  date: 2021-08-08 author: <a href="https://bestia.dev" rel="nofollow">bestia.dev</a> repository: <a href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup">GitHub</a></strong></em></p>
<p dir="auto"><a href="https://hits.seeyoufarm.com" rel="nofollow"><img src="https://camo.githubusercontent.com/b2501ff9c75451191c50ae40a988ceed61f01da8c2885397fac17d61bc53ac1d/68747470733a2f2f686974732e736565796f756661726d2e636f6d2f6170692f636f756e742f696e63722f62616467652e7376673f75726c3d68747470732533412532462532466769746875622e636f6d2532466265737469612d6465762532466c6f6e67616e5f6e616e6f5f727573745f77736c325f706c6174666f726d696f5f736574757026636f756e745f62673d253233373943383344267469746c655f62673d2532333535353535352669636f6e3d2669636f6e5f636f6c6f723d253233453745374537267469746c653d6869747326656467655f666c61743d66616c7365" alt="Hits" data-canonical-src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2Fbestia-dev%2Flongan_nano_rust_wsl2_platformio_setup&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=hits&amp;edge_flat=false" style="max-width: 100%;"></a></p>
<p dir="auto">Hashtags: #rustlang #riscv #embeddeddevelopment</p>
<h2 dir="auto"><a id="user-content-sipeed-longan-nano" class="anchor" aria-hidden="true" href="#sipeed-longan-nano"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Sipeed Longan nano</h2>
<p dir="auto">I just received my 2 <a href="http://longan.sipeed.com/en/" rel="nofollow">Sipeed Longan nano</a> development boards ordered on <a href="https://www.aliexpress.com/item/4000505297604.html?spm=a2g0s.9042311.0.0.6b4b4c4dYrInFR" rel="nofollow">AliExpress</a>. They are cute and cheap. One has even a tiny lcd display.<br>
The Risc-V chip on the board is GD32VF103CBT6 or in short <a href="https://www.gigadevice.com/products/microcontrollers/gd32/" rel="nofollow">GD32V</a> from GigaDevice.
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/longan_nano_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/longan_nano_1.png" alt="Longan nano" title="Longan nano" style="max-width: 100%;"></a><br>
I always wanted to play with a <a href="https://riscv.org/about/" rel="nofollow">Risc-V</a> micro-processor. I think they are the future. I believe they will grow and will be used in phones, laptops and servers, not only in microcontrollers. But I hope designers will find a way to avoid <a href="https://en.wikipedia.org/wiki/Malware" rel="nofollow">malware</a> inside the silicon. That would be a ruined future.</p>
<h2 dir="auto"><a id="user-content-rust-on-wsl" class="anchor" aria-hidden="true" href="#rust-on-wsl"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Rust on WSL</h2>
<p dir="auto">Usually the microcontroller is programmed in C, but I am a fan of the <a href="https://www.rust-lang.org/" rel="nofollow">rust</a> programming language and want to try it with Longan Nano.<br>
I use <a href="https://code.visualstudio.com/" rel="nofollow">VSCode</a> in <a href="https://www.microsoft.com/sl-si/software-download/windows10" rel="nofollow">Win10</a>, but all <a href="https://www.rust-lang.org/" rel="nofollow">rust</a> coding and building happens inside <a href="https://www.sitepoint.com/wsl2/" rel="nofollow">WSL2</a> in <a href="https://www.debian.org/" rel="nofollow">Debian Linux</a>.<br>
This combination works very well for building <a href="https://en.wikipedia.org/wiki/Command-line_interface" rel="nofollow">CLI</a> and <a href="https://en.wikipedia.org/wiki/WebAssembly" rel="nofollow">Wasm</a> applications in Rust.<br>
VSCode has a plugin <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl" rel="nofollow">Remote - WSL extension</a> that installs a "vscode server" in Debian. Then the VSCode Win10 <a href="https://en.wikipedia.org/wiki/Graphical_user_interface" rel="nofollow">GUI</a> frontend talks to the "remote" Debian WSL2 backend for all files and operations. All the files and development tools are in Debian. Only the GUI is in Windows.</p>
<p dir="auto">Short instructions:<br>
Install <a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10" rel="nofollow">WSL2</a> and inside it the <a href="https://www.debian.org/" rel="nofollow">Debian Linux distro</a>.<br>
In Debian we need rust (rust programming language). Use <a href="https://www.rust-lang.org/learn/get-started" rel="nofollow">rustup</a> to install it, find it on their <a href="https://www.rust-lang.org/" rel="nofollow">official page</a>.  Something like this:<br>
<code>$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh</code></p>
<p dir="auto">Install <a href="https://code.visualstudio.com/" rel="nofollow">VSCode</a> in Win10.<br>
Then in VSCode install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl" rel="nofollow">Remote - WSL extension</a>.<br>
I like to have this "local plugin" (in Win10) for VSCode:</p>
<ul dir="auto">
<li><a href="https://marketplace.visualstudio.com/items?itemName=vscode-icons-team.vscode-icons" rel="nofollow">vscode-icons</a></li>
</ul>
<p dir="auto">and these "WSL-Debian plugins":</p>
<ul dir="auto">
<li><a href="https://marketplace.visualstudio.com/items?itemName=matklad.rust-analyzer" rel="nofollow">rust-analyzer</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=streetsidesoftware.code-spell-checker" rel="nofollow">Code Spell Checker</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=serayuzgur.crates" rel="nofollow">crates</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=DavidAnson.vscode-markdownlint" rel="nofollow">markdownlint</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=2gua.rainbow-brackets" rel="nofollow">Rainbow Brackets</a></li>
</ul>
<h2 dir="auto"><a id="user-content-platformio-pio" class="anchor" aria-hidden="true" href="#platformio-pio"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>PlatformIO (PIO)</h2>
<p dir="auto"><a href="https://marketplace.visualstudio.com/items?itemName=platformio.platformio-ide" rel="nofollow">PlatformIO</a> is a plugin/extension for VSCode. It allows to build and download programs to the development board right inside VSCode. Install this extension in WSL-Debian.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_2.png" alt="pio_2" title="pio_2" style="max-width: 100%;"></a><br>
Then install the platform gd32v for you Longan Nano board. Click on the extension icon (the alien face), then click on New Terminal and then type:<br>
<code>platformio platform install gd32v</code><br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_1.png" alt="pio_1" title="pio_1" style="max-width: 100%;"></a></p>
<h2 dir="auto"><a id="user-content-dfu-device-firmware-upgrade-driver" class="anchor" aria-hidden="true" href="#dfu-device-firmware-upgrade-driver"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>DFU (Device Firmware Upgrade) driver</h2>
<p dir="auto">The Nano can be simply connected with a usb-C cable to the computer for power and data communication.<br>
Sadly we cannot use WSL2 for USB special communication. All the USB are attached natively to Win10 and we must use it exclusively on Win10. But I have a workaround ;-)<br>
Connect your Nano to the computer with a usb-c cable.<br>
Now the USB is used only for power. This is the "normal mode". Windows does not recognize any USB device.<br>
If you press and hold the <code>BOOT0</code> (right) button and then press shortly the <code>RESET</code> (left) button and then release the <code>BOOT0</code> button, you will put the Longan Nano in "<a href="http://wiki.openmoko.org/wiki/USB_DFU_-_The_USB_Device_Firmware_Upgrade_standard" rel="nofollow">DFU mode</a>". Now the Longan nano is communicating with the computer over usb. This special mode is used to upgrade the firmware and it is a official USB standard. You will need to do this every time you want to upgrade the firmware and that is super often in development. Get comfortable with these super tiny buttons ;-)</p>
<p dir="auto">In the moment Longan Nano enters the "DFU mode" Win10 will recognize a new USB device and usually make a sound. Open the Device Manager: click on Start and type <em>manage</em>, this will show the Device Manager in the results and then click on it. Or just type <code>devmgmt.msc</code> in the command prompt or PowerShell.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_1.png" alt="device manager 1" title="device_manager_1" style="max-width: 100%;"></a><br>
If the Device Manager is already opened, in the moment you activate the "dfu mode" on the board, Device Manager will refresh to show the new usb device. Leave the Device manager open, we will need it a lot the first time to setup the thing.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_2.png" alt="device manager 2" title="device_manager_2" style="max-width: 100%;"></a><br>
We can see a new "Unknown device" when the Nano is in "DFU mode". That is not good enough. We need a driver.<br>
First we will install the original driver from Sipeed. Open the page<br>
<a href="http://dl.sipeed.com/LONGAN/Nano/Tools" rel="nofollow">http://dl.sipeed.com/LONGAN/Nano/Tools</a><br>
and click on <code>GD32_MCU_Dfu_Tool_V3.8.1.5784_1.rar</code> to download the 10MB drivers. Don't miss the captcha or <code>you are a robot</code> ;-)<br>
Unzip the foldersï¼šGD32 MCU Dfu Drivers_v1.0.1.2316<br>
Right click on <code>GD32 MCU Dfu Drivers_v1.0.1.2316\x64\GD32 MCU Dfu Drivers.exe</code> and run as administrator.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/driver_install_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/driver_install_1.png" alt="driver_install_1" title="driver_install_1" style="max-width: 100%;"></a><br>
Click on Install and after successful installation click Cancel to close the window. Strange choice of words "Cancel", it should be "Close". Also in their <a href="https://longan.sipeed.com/en/" rel="nofollow">online instructions</a> is really visible that the main effort was in Chinese and not in the English language. Some translations are pretty bad.<br>
Now in Device Manager at the bottom in the section "Universal Serial Bus controllers" we see the new driver.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_3.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_3.png" alt="device manager 3" title="device_manager_3" style="max-width: 100%;"></a><br>
This would be enough if we wanted to use the application from Sipeed: <code>GD32 MCU Dfu Tool_v3.8.1.5784\GD32 MCU Dfu Tool.exe</code>. But we don't want to do that. It is a windows GUI application, and we want to use a CLI application that can be a part of our workflow for building and downloading to the Longan Nano.<br>
<code>Interesting:</code> the word "download" is used to send the firmware from the computer to the board and the word "upload" is used to send the firmware from the board to the computer. For me it sounds confusing, but this is the professional lingo!</p>
<h2 dir="auto"><a id="user-content-dfu-util-and-zadig" class="anchor" aria-hidden="true" href="#dfu-util-and-zadig"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>dfu-util and Zadig</h2>
<p dir="auto">We want to use the CLI application <a href="http://dfu-util.sourceforge.net/" rel="nofollow">dfu-utils</a>.<br>
There are a few problems there and we need to find some workarounds, so bear with me and be extra attentive.</p>
<p dir="auto">The best use of <code>dfu-util</code> is from <code>Linux</code>, but as I said earlier we have no luck, because <code>WSL2</code> does not use native USB.<br>
There exists also the release <code>dfu-util for Windows 0.9</code>, but it has a bug and does not work with the GD32 driver.<br>
I have you covered. Here is the workaround:</p>
<p dir="auto">We need a special type of driver called <a href="https://en.wikipedia.org/wiki/WinUSB" rel="nofollow">WinUSB</a>. We will use the application <a href="https://zadig.akeo.ie/" rel="nofollow">Zadig</a> to replace our GD32 driver with the WinUSB driver. Open the page <a href="https://zadig.akeo.ie/" rel="nofollow">https://zadig.akeo.ie/</a> and click on <code>Zadig 2.5 (4.9 MB)</code> to download it.<br>
Put your Longan Nona in "dfu mode". You know: BOOT0 and RESET buttons.<br>
Double click on <code>zadig-2.5.exe</code> to run it. You will be asked <code>Do you want to allow this app to make changes to your device?</code> and choose Yes. It is a driver, it must change something.<br>
From the menu choose Options - List All Devices.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_1.png" alt="zadig_1" title="zadig_1" style="max-width: 100%;"></a><br>
When you open the DropDown there is bunch of existing usb drivers.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_2.png" alt="zadig_2" title="zadig_2" style="max-width: 100%;"></a><br>
Interestingly, there is one driver without a name. I don't know why, but this is our GD32 driver. Click on it.<br>
I want to give this driver a name. Click on the checkbox Edit,<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_3.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_3.png" alt="zadig_3" title="zadig_3" style="max-width: 100%;"></a><br>
write the driver name "WinUSB Longan Nano"<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_4.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_4.png" alt="zadig_4" title="zadig_4" style="max-width: 100%;"></a><br>
and click again on the Edit checkbox.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_5.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_5.png" alt="zadig_5" title="zadig_5" style="max-width: 100%;"></a><br>
Now the driver has a name. I hope.<br>
And now the magic part. Click on <code>Replace Driver</code>.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_6.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_6.png" alt="zadig_6" title="zadig_6" style="max-width: 100%;"></a><br>
Say Yes.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_8.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_8.png" alt="zadig_8" title="zadig_8" style="max-width: 100%;"></a><br>
Be patient.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_9.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/zadig_9.png" alt="zadig_9" title="zadig_9" style="max-width: 100%;"></a><br>
Done! Close it.</p>
<p dir="auto">Open Device Manager and put the Nano in "dfu mode" again. The new situation has a new "Universal Serial Bus devices", but sadly it is called Unknown device.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_4.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_4.png" alt="device manager 4" title="device_manager_4" style="max-width: 100%;"></a><br>
Double click on it and choose the tab Details and you will see that it is really our new driver "WinUSB Longan Nano".<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_5.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/device_manager_5.png" alt="device manager 5" title="device_manager_5" style="max-width: 100%;"></a></p>
<p dir="auto">The dfu-util for Windows you can download on the internet is version 0.9. Sadly it has a bug and it does not work for GD32V. But I have a workaround. The people from PlatformIO have built the version 0.10 for Windows, but it is not available on the internet to download. But we get it when we install PlatformIO on VSCode on Windows. I did that. I found the <code>tool-dfuutil\bin</code> folder in <code>c:\Users\Luciano\.platformio\packages\tool-dfuutil\bin</code>.<br>
Here you can download the bin folder:<br>
<a href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/tool-dfuutil/bin.zip">https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/tool-dfuutil/bin.zip</a></p>
<p dir="auto">Now we can empty the <code>tool-dfuutil/bin</code> folder on WSL2, because it will never work in Linux in WSL2.<br>
If you use a windows tool (I use Total Commander) the path is:<br>
<code>\\wsl$\Debian\home\luciano\.platformio\packages\tool-dfuutil\bin</code>.<br>
If you use a Linux tool the path is: <code>~/.platformio/packages/tool-dfuutil/bin</code>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/tool-dfuutil_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/tool-dfuutil_1.png" alt="tool-dfuutil_1.png" title="tool-dfuutil_1.png" style="max-width: 100%;"></a><br>
Just delete all 4 files. We will not need them, never.</p>
<p dir="auto">Now copy the content of the zip file to that folder. It sounds strange to have Windows exe files inside a linux folder, but trust me. It will work on WSL2 because of a magic collaboration between Windows and WSL2.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/tool-dfuutil_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/tool-dfuutil_2.png" alt="tool-dfuutil_2.png" title="tool-dfuutil_2.png" style="max-width: 100%;"></a><br>
The Linux PlatformIO cannot directly call the windows exe files because they have the extension <code>.exe</code>.<br>
But we can create <a href="https://en.wikipedia.org/wiki/Symbolic_link" rel="nofollow">symlinks</a>, so it will look to PlatformIO as nothing has changed. Run this in Linux bash:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="ln -s ~/.platformio/packages/tool-dfuutil/bin/dfu-util.exe ~/.platformio/packages/tool-dfuutil/bin/dfu-util
ln -s ~/.platformio/packages/tool-dfuutil/bin/dfu-suffix.exe ~/.platformio/packages/tool-dfuutil/bin/dfu-suffix
ln -s ~/.platformio/packages/tool-dfuutil/bin/dfu-prefix.exe ~/.platformio/packages/tool-dfuutil/bin/dfu-prefix"><pre>ln -s <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-util.exe <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-util
ln -s <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-suffix.exe <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-suffix
ln -s <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-prefix.exe <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-prefix</pre></div>
<p dir="auto">make it executable</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="chmod +x ~/.platformio/packages/tool-dfuutil/bin/dfu-util
chmod +x ~/.platformio/packages/tool-dfuutil/bin/dfu-suffix
chmod +x ~/.platformio/packages/tool-dfuutil/bin/dfu-prefix"><pre>chmod +x <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-util
chmod +x <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-suffix
chmod +x <span class="pl-k">~</span>/.platformio/packages/tool-dfuutil/bin/dfu-prefix</pre></div>
<p dir="auto">Et voilÃ â€¯! There we are !</p>
<h2 dir="auto"><a id="user-content-original-blinky-example-in-c" class="anchor" aria-hidden="true" href="#original-blinky-example-in-c"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Original Blinky example in C</h2>
<p dir="auto">Let's try our environment now.<br>
Open VSCode. Normally it opens in Windows Mode. You can tell by the green box in the left bottom corner. This is how it looks for Windows mode:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_1.png" alt="vscode_1.png" title="vscode_1.png" style="max-width: 100%;"></a><br>
and this is how it looks in WSL-Debian mode:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_2.png" alt="vscode_2.png" title="vscode_2.png" style="max-width: 100%;"></a><br>
If you click on this green box it opens some new commands:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_3.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_3.png" alt="vscode_3.png" title="vscode_3.png" style="max-width: 100%;"></a><br>
Click on <code>New WSL Window</code> and now your VSCode is in WSL-Debian mode.<br>
Click on the icon for PlatformIO and then Open and then <code>Project Examples</code>.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_4.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_4.png" alt="vscode_4.png" title="vscode_4.png" style="max-width: 100%;"></a><br>
Select an example<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_5.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_5.png" alt="vscode_5.png" title="vscode_5.png" style="max-width: 100%;"></a><br>
Choose Arduino blink<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_6.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_6.png" alt="vscode_6.png" title="vscode_6.png" style="max-width: 100%;"></a><br>
Click Import<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_7.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_7.png" alt="vscode_7.png" title="vscode_7.png" style="max-width: 100%;"></a><br>
The folder of the imported projects shows:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_8.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_8.png" alt="vscode_8.png" title="vscode_8.png" style="max-width: 100%;"></a><br>
Now we can open this project folder:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_9.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/vscode_9.png" alt="vscode_9.png" title="vscode_9.png" style="max-width: 100%;"></a><br>
Observe that we are working in the Linux file system :<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_1.png" alt="blink_1.png" title="blink_1.png" style="max-width: 100%;"></a><br>
If it asks you to trust the author, answer Yes.<br>
This is our project now:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_2.png" alt="blink_2.png" title="blink_2.png" style="max-width: 100%;"></a><br>
We have to make some changes to the <code>platformio.ini</code> to look like this:</p>
<div class="highlight highlight-source-ini notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="; https://docs.platformio.org/page/projectconf.html

[env:sipeed-longan-nano]
platform = gd32v
framework = arduino
board = sipeed-longan-nano
monitor_speed = 115200
upload_protocol = dfu"><pre><span class="pl-c"><span class="pl-c">;</span> https://docs.platformio.org/page/projectconf.html</span>

<span class="pl-en">[env:sipeed-longan-nano]</span>
<span class="pl-k">platform</span> = gd32v
<span class="pl-k">framework</span> = arduino
<span class="pl-k">board</span> = sipeed-longan-nano
<span class="pl-k">monitor_speed</span> = 115200
<span class="pl-k">upload_protocol</span> = dfu</pre></div>
<p dir="auto">Time to build! On the bottom status bar find and click on this (PlatformIO: Build):<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_3.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_3.png" alt="blink_3.png" title="blink_3.png" style="max-width: 100%;"></a><br>
Build successful:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_4.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_4.png" alt="blink_4.png" title="blink_4.png" style="max-width: 100%;"></a><br>
Time to download our app to the board. Put your Nano in "dfu mode" (remember BOOT0 and RESET buttons). In the bottom status bar find and click on this (PlatformIO: Upload):<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_5.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_5.png" alt="blink_5.png" title="blink_5.png" style="max-width: 100%;"></a><br>
Download successful:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_6.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/blink_6.png" alt="blink_6.png" title="blink_6.png" style="max-width: 100%;"></a><br>
Observe your Longan Nano how the LED blinks red.<br>
It's alive !</p>
<h2 dir="auto"><a id="user-content-pio--rust-project" class="anchor" aria-hidden="true" href="#pio--rust-project"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>PIO + rust project</h2>
<p dir="auto">We will use a <a href="https://doc.rust-lang.org/cargo/guide/index.html" rel="nofollow">cargo</a> plugin to create a new project that has all the files and folder structure to start a project with PIO and rust. This plugin is called <a href="https://github.com/ivmarkov/cargo-pio">cargo-pio</a>.<br>
Run in Debian:<br>
<code>$ cargo install cargo-pio</code><br>
We will need also a target for the Risc-V processor (in Debian):<br>
<code>$ rustup target add riscv32imac-unknown-none-elf</code><br>
PlatformIO needs Python 3. Debian comes preinstalled with it. Upgrade to the latest version in Debian packages (Debian is always a little behind):</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="sudo apt update
sudo apt -y upgrade
python3 -V"><pre>sudo apt update
sudo apt -y upgrade
python3 -V</pre></div>
<p dir="auto">The new project will be next to our other rust projects:<br>
<code>$ cd ~/rustprojects/</code><br>
The magic incantation will create a scaffold for our first project <code>blinky_blue</code>:<br>
<code>$  cargo pio new -b sipeed-longan-nano -p gd32v blinky_blue</code><br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_3.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/pio_3.png" alt="pio_3.png" title="pio_3.png" style="max-width: 100%;"></a></p>
<p dir="auto">Open VSCode in Windows, change it to WSL-Debian mode (left bottom green box), click on New WSL Window, click Open Folder and find<br>
<code>~/rustprojects/blinky_blue/</code><br>
or equivalent, but with your username<br>
<code>/home/luciano/rustprojects/blinky_blue/</code><br>
and click OK.</p>
<p dir="auto">We need to change the <code>[env]</code> section of platform.ini:</p>
<div class="highlight highlight-source-ini notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[env]
extra_scripts = pre:platformio.git.py, pre:platformio.patch.py, platformio.cargo.py
board = sipeed-longan-nano
platform = gd32v
framework = gd32vf103-sdk
rust_lib = blinky_blue
rust_target = riscv32imac-unknown-none-elf
monitor_speed = 115200
upload_protocol = dfu"><pre><span class="pl-en">[env]</span>
<span class="pl-k">extra_scripts</span> = pre:platformio.git.py, pre:platformio.patch.py, platformio.cargo.py
<span class="pl-k">board</span> = sipeed-longan-nano
<span class="pl-k">platform</span> = gd32v
<span class="pl-k">framework</span> = gd32vf103-sdk
<span class="pl-k">rust_lib</span> = blinky_blue
<span class="pl-k">rust_target</span> = riscv32imac-unknown-none-elf
<span class="pl-k">monitor_speed</span> = 115200
<span class="pl-k">upload_protocol</span> = dfu</pre></div>
<p dir="auto">In Cargo.toml we will add some <code>[dependencies]</code>:</p>
<div class="highlight highlight-source-toml notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[dependencies]
riscv-rt = &quot;0.8.0&quot;
longan-nano = &quot;0.2.0&quot;"><pre>[<span class="pl-en">dependencies</span>]
<span class="pl-smi">riscv-rt</span> = <span class="pl-s"><span class="pl-pds">"</span>0.8.0<span class="pl-pds">"</span></span>
<span class="pl-smi">longan-nano</span> = <span class="pl-s"><span class="pl-pds">"</span>0.2.0<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">and most important we have to change the edition in  <code>[lib]</code> section from 2015 to 2018 else you get the cryptic error<br>
<code>error[E0433]: failed to resolve: maybe a missing crate longan_nano?</code>:</p>
<div class="highlight highlight-source-toml notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="[lib]
...
edition = &quot;2018&quot;
..."><pre>[<span class="pl-en">lib</span>]
<span class="pl-ii">...</span>
<span class="pl-smi">edition</span> = <span class="pl-s"><span class="pl-pds">"</span>2018<span class="pl-pds">"</span></span>
<span class="pl-ii">...</span></pre></div>
<p dir="auto">In .gitignore we add the <code>target/</code> folder next to the <code>.pio</code>:</p>
<div class="highlight highlight-source-ini notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content=".pio/
target/"><pre>.pio/
target/</pre></div>
<p dir="auto">Finally we come to coding in rust.<br>
In <code>src/lib.rs</code> we remove the <code>ESP-IDF</code> and <code>Arduino</code> sections. The remaining <code>All others</code> section should look like this:</p>
<div class="highlight highlight-source-rust notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="////////////////////////////////////////////////////////
// All others                                         //
////////////////////////////////////////////////////////

use longan_nano::hal::{pac, prelude::*};
use longan_nano::led::{Led, rgb};

#[no_mangle]
extern &quot;C&quot; fn main() -&gt; i32 {
    let dp = pac::Peripherals::take().unwrap();
    let mut rcu = dp.RCU.configure().sysclk(108.mhz()).freeze();

    let gpioa = dp.GPIOA.split(&amp;mut rcu);
    let gpioc = dp.GPIOC.split(&amp;mut rcu);

     let (mut red, mut green, mut blue) = rgb(gpioc.pc13, gpioa.pa1, gpioa.pa2);
     let leds: [&amp;mut dyn Led; 3] = [&amp;mut red, &amp;mut green, &amp;mut blue];

    leds[0].off();
    leds[1].off();
    leds[2].off();

    let mut i = 0;
    let mut on_off = false;
    loop {
        if i &gt; 5_000_000 {
            i = 0;
            if on_off==false{
                leds[2].off();
                on_off=true;                
            }else{
                leds[2].on();
                on_off=false;
            }
        } else{
            i += 1;
        }
    }
    0
}"><pre><span class="pl-c">////////////////////////////////////////////////////////</span>
<span class="pl-c">// All others                                         //</span>
<span class="pl-c">////////////////////////////////////////////////////////</span>

<span class="pl-k">use</span> longan_nano<span class="pl-k">::</span>hal<span class="pl-k">::</span>{pac, prelude<span class="pl-k">::</span><span class="pl-k">*</span>};
<span class="pl-k">use</span> longan_nano<span class="pl-k">::</span>led<span class="pl-k">::</span>{Led, rgb};

#[no_mangle]
<span class="pl-k">extern</span> <span class="pl-s">"C"</span> <span class="pl-k">fn</span> <span class="pl-en">main</span>() -&gt; <span class="pl-k">i32</span> {
    <span class="pl-k">let</span> dp <span class="pl-k">=</span> pac<span class="pl-k">::</span>Peripherals<span class="pl-k">::</span><span class="pl-en">take</span>().<span class="pl-en">unwrap</span>();
    <span class="pl-k">let</span> <span class="pl-k">mut</span> rcu <span class="pl-k">=</span> dp.RCU.<span class="pl-en">configure</span>().<span class="pl-en">sysclk</span>(<span class="pl-c1">108</span>.<span class="pl-en">mhz</span>()).<span class="pl-en">freeze</span>();

    <span class="pl-k">let</span> gpioa <span class="pl-k">=</span> dp.GPIOA.<span class="pl-en">split</span>(<span class="pl-k">&amp;</span><span class="pl-k">mut</span> rcu);
    <span class="pl-k">let</span> gpioc <span class="pl-k">=</span> dp.GPIOC.<span class="pl-en">split</span>(<span class="pl-k">&amp;</span><span class="pl-k">mut</span> rcu);

     <span class="pl-k">let</span> (<span class="pl-k">mut</span> red, <span class="pl-k">mut</span> green, <span class="pl-k">mut</span> blue) <span class="pl-k">=</span> <span class="pl-en">rgb</span>(gpioc.pc13, gpioa.pa1, gpioa.pa2);
     <span class="pl-k">let</span> leds: [<span class="pl-k">&amp;</span><span class="pl-k">mut</span> <span class="pl-k">dyn</span> Led; <span class="pl-c1">3</span>] <span class="pl-k">=</span> [<span class="pl-k">&amp;</span><span class="pl-k">mut</span> red, <span class="pl-k">&amp;</span><span class="pl-k">mut</span> green, <span class="pl-k">&amp;</span><span class="pl-k">mut</span> blue];

    leds[<span class="pl-c1">0</span>].<span class="pl-en">off</span>();
    leds[<span class="pl-c1">1</span>].<span class="pl-en">off</span>();
    leds[<span class="pl-c1">2</span>].<span class="pl-en">off</span>();

    <span class="pl-k">let</span> <span class="pl-k">mut</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>;
    <span class="pl-k">let</span> <span class="pl-k">mut</span> on_off <span class="pl-k">=</span> <span class="pl-c1">false</span>;
    <span class="pl-k">loop</span> {
        <span class="pl-k">if</span> i <span class="pl-k">&gt;</span> <span class="pl-c1">5_000_000</span> {
            i <span class="pl-k">=</span> <span class="pl-c1">0</span>;
            <span class="pl-k">if</span> on_off<span class="pl-k">==</span><span class="pl-c1">false</span>{
                leds[<span class="pl-c1">2</span>].<span class="pl-en">off</span>();
                on_off<span class="pl-k">=</span><span class="pl-c1">true</span>;                
            }<span class="pl-k">else</span>{
                leds[<span class="pl-c1">2</span>].<span class="pl-en">on</span>();
                on_off<span class="pl-k">=</span><span class="pl-c1">false</span>;
            }
        } <span class="pl-k">else</span>{
            i <span class="pl-k">+=</span> <span class="pl-c1">1</span>;
        }
    }
    <span class="pl-c1">0</span>
}</pre></div>
<p dir="auto">Good.<br>
Now we can click on <code>PlatformIO: Build</code> button in the status bar.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/build_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/build_1.png" alt="build_1.png" title="build_1.png" style="max-width: 100%;"></a><br>
And we have a successful build.</p>
<p dir="auto">Put the Longan Nano in <code>DFU mode</code> (BOOT0 and RESET mini-buttons) and click on <code>PlatformIO: Upload</code> button on the statusbar.<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/build_2.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/build_2.png" alt="build_2.png" title="build_2.png" style="max-width: 100%;"></a><br>
It works! The Nano has a blinking blue LED !<br>
Congratulations !
You were very patient if you come to this line. The setup of the environment is not super smooth, but once you got it, it's done. You don't have to repeat it.<br>
And now I leave you to your fantasy, so you can code some great rust programs for Longan Nano.</p>
<h2 dir="auto"><a id="user-content-git-and-github" class="anchor" aria-hidden="true" href="#git-and-github"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>git and GitHub</h2>
<p dir="auto">Just to finish in beauty: we will create a remote repository in Github and push our project.<br>
I tried the <code>GitHub CLI</code>, but it looks awful. I will not use it.<br>
I think VSCode already installs git, so you don't have to worry about it.<br>
You need to have already a <a href="https://github.com/">GitHub</a> account and your SSH key for GitHub <a href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">prepared</a> and <a href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">added</a> to GitHub.<br>
In the VSCode terminal (Ctrl+j) I use ssh-agent to have the GitHub authorization in the background exclusively for this terminal session:<br>
<code>$ /usr/bin/ssh-agent</code><br>
I add my github SSH key to the agent:<br>
<code>$ ssh-add ~/.ssh/lucianobestia_mac</code><br>
I type my passphrase to authenticate that this is really me.</p>
<p dir="auto">Open in your browser <a href="https://github.com">https://github.com</a>, login and there will be a big green <code>New</code> button. Click on it:</p>
<ul dir="auto">
<li><code>Repository name:</code> blinky_blue</li>
<li><code>Description:</code> minimal rust program for Longan Nano</li>
<li>click <code>Public</code> if needed</li>
<li>uncheck (if needed): <code>Add README file</code></li>
<li>uncheck (if needed): <code>Add .gitignore</code></li>
<li>uncheck (if needed): <code>Choose a license</code></li>
<li><code>Create repository</code></li>
</ul>
<p dir="auto">The remote repository is created and instructions are shown:</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/github_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/github_1.png" alt="github_1" title="github_1" style="max-width: 100%;"></a></p>
<p dir="auto">Click on the button to copy the commands. Open the Debian bash terminal inside VSCode (Ctrl+j) and paste the commands.<br>
Now that the git and GitHub repositories are set, you can use VSCode icons (1) to commit (2+3) and push (4) to remote:<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/git_vscode_1.png"><img src="https://github.com/bestia-dev/longan_nano_rust_wsl2_platformio_setup/raw/main/images/git_vscode_1.png" alt="git_vscode_1.png" title="git_vscode_1.png" style="max-width: 100%;"></a></p>
<p dir="auto">You can find my repository here:
<a href="https://github.com/bestia-dev/blinky_blue">https://github.com/bestia-dev/blinky_blue</a><br>
You can clone it locally like this:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="cd ~/rustprojects
git clone git@github.com:bestia-dev/blinky_blue.git"><pre><span class="pl-c1">cd</span> <span class="pl-k">~</span>/rustprojects
git clone git@github.com:bestia-dev/blinky_blue.git</pre></div>
</article>
</body>

</html>